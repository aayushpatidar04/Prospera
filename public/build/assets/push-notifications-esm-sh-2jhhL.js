function ue(c){if(Array.isArray(c)){for(var r=0,t=new Array(c.length);r<c.length;r++)t[r]=c[r];return t}}var oe=ue;function ce(c){if(Symbol.iterator in Object(c)||Object.prototype.toString.call(c)==="[object Arguments]")return Array.from(c)}var he=ce;function le(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var de=le;function ve(c){return oe(c)||he(c)||de()}var fe=ve;function pe(c,r){return r={exports:{}},c(r,r.exports),r.exports}var we=pe(function(c){var r=(function(t){var i=Object.prototype,n=i.hasOwnProperty,e,s=typeof Symbol=="function"?Symbol:{},a=s.iterator||"@@iterator",l=s.asyncIterator||"@@asyncIterator",v=s.toStringTag||"@@toStringTag";function k(o,u,h,p){var f=u&&u.prototype instanceof j?u:j,S=Object.create(f.prototype),I=new H(p||[]);return S._invoke=ie(o,h,I),S}t.wrap=k;function y(o,u,h){try{return{type:"normal",arg:o.call(u,h)}}catch(p){return{type:"throw",arg:p}}}var g="suspendedStart",U="suspendedYield",b="executing",m="completed",D={};function j(){}function L(){}function C(){}var K={};K[a]=function(){return this};var B=Object.getPrototypeOf,G=B&&B(B(q([])));G&&G!==i&&n.call(G,a)&&(K=G);var N=C.prototype=j.prototype=Object.create(K);L.prototype=N.constructor=C,C.constructor=L,C[v]=L.displayName="GeneratorFunction";function X(o){["next","throw","return"].forEach(function(u){o[u]=function(h){return this._invoke(u,h)}})}t.isGeneratorFunction=function(o){var u=typeof o=="function"&&o.constructor;return u?u===L||(u.displayName||u.name)==="GeneratorFunction":!1},t.mark=function(o){return Object.setPrototypeOf?Object.setPrototypeOf(o,C):(o.__proto__=C,v in o||(o[v]="GeneratorFunction")),o.prototype=Object.create(N),o},t.awrap=function(o){return{__await:o}};function M(o){function u(f,S,I,_){var P=y(o[f],o,S);if(P.type==="throw")_(P.arg);else{var E=P.arg,A=E.value;return A&&typeof A=="object"&&n.call(A,"__await")?Promise.resolve(A.__await).then(function(T){u("next",T,I,_)},function(T){u("throw",T,I,_)}):Promise.resolve(A).then(function(T){E.value=T,I(E)},function(T){return u("throw",T,I,_)})}}var h;function p(f,S){function I(){return new Promise(function(_,P){u(f,S,_,P)})}return h=h?h.then(I,I):I()}this._invoke=p}X(M.prototype),M.prototype[l]=function(){return this},t.AsyncIterator=M,t.async=function(o,u,h,p){var f=new M(k(o,u,h,p));return t.isGeneratorFunction(u)?f:f.next().then(function(S){return S.done?S.value:f.next()})};function ie(o,u,h){var p=g;return function(S,I){if(p===b)throw new Error("Generator is already running");if(p===m){if(S==="throw")throw I;return F()}for(h.method=S,h.arg=I;;){var _=h.delegate;if(_){var P=Y(_,h);if(P){if(P===D)continue;return P}}if(h.method==="next")h.sent=h._sent=h.arg;else if(h.method==="throw"){if(p===g)throw p=m,h.arg;h.dispatchException(h.arg)}else h.method==="return"&&h.abrupt("return",h.arg);p=b;var E=y(o,u,h);if(E.type==="normal"){if(p=h.done?m:U,E.arg===D)continue;return{value:E.arg,done:h.done}}else E.type==="throw"&&(p=m,h.method="throw",h.arg=E.arg)}}}function Y(o,u){var h=o.iterator[u.method];if(h===e){if(u.delegate=null,u.method==="throw"){if(o.iterator.return&&(u.method="return",u.arg=e,Y(o,u),u.method==="throw"))return D;u.method="throw",u.arg=new TypeError("The iterator does not provide a 'throw' method")}return D}var p=y(h,o.iterator,u.arg);if(p.type==="throw")return u.method="throw",u.arg=p.arg,u.delegate=null,D;var f=p.arg;if(!f)return u.method="throw",u.arg=new TypeError("iterator result is not an object"),u.delegate=null,D;if(f.done)u[o.resultName]=f.value,u.next=o.nextLoc,u.method!=="return"&&(u.method="next",u.arg=e);else return f;return u.delegate=null,D}X(N),N[v]="Generator",N[a]=function(){return this},N.toString=function(){return"[object Generator]"};function se(o){var u={tryLoc:o[0]};1 in o&&(u.catchLoc=o[1]),2 in o&&(u.finallyLoc=o[2],u.afterLoc=o[3]),this.tryEntries.push(u)}function V(o){var u=o.completion||{};u.type="normal",delete u.arg,o.completion=u}function H(o){this.tryEntries=[{tryLoc:"root"}],o.forEach(se,this),this.reset(!0)}t.keys=function(o){var u=[];for(var h in o)u.push(h);return u.reverse(),function p(){for(;u.length;){var f=u.pop();if(f in o)return p.value=f,p.done=!1,p}return p.done=!0,p}};function q(o){if(o){var u=o[a];if(u)return u.call(o);if(typeof o.next=="function")return o;if(!isNaN(o.length)){var h=-1,p=function f(){for(;++h<o.length;)if(n.call(o,h))return f.value=o[h],f.done=!1,f;return f.value=e,f.done=!0,f};return p.next=p}}return{next:F}}t.values=q;function F(){return{value:e,done:!0}}return H.prototype={constructor:H,reset:function(o){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(V),!o)for(var u in this)u.charAt(0)==="t"&&n.call(this,u)&&!isNaN(+u.slice(1))&&(this[u]=e)},stop:function(){this.done=!0;var o=this.tryEntries[0],u=o.completion;if(u.type==="throw")throw u.arg;return this.rval},dispatchException:function(o){if(this.done)throw o;var u=this;function h(P,E){return S.type="throw",S.arg=o,u.next=P,E&&(u.method="next",u.arg=e),!!E}for(var p=this.tryEntries.length-1;p>=0;--p){var f=this.tryEntries[p],S=f.completion;if(f.tryLoc==="root")return h("end");if(f.tryLoc<=this.prev){var I=n.call(f,"catchLoc"),_=n.call(f,"finallyLoc");if(I&&_){if(this.prev<f.catchLoc)return h(f.catchLoc,!0);if(this.prev<f.finallyLoc)return h(f.finallyLoc)}else if(I){if(this.prev<f.catchLoc)return h(f.catchLoc,!0)}else if(_){if(this.prev<f.finallyLoc)return h(f.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(o,u){for(var h=this.tryEntries.length-1;h>=0;--h){var p=this.tryEntries[h];if(p.tryLoc<=this.prev&&n.call(p,"finallyLoc")&&this.prev<p.finallyLoc){var f=p;break}}f&&(o==="break"||o==="continue")&&f.tryLoc<=u&&u<=f.finallyLoc&&(f=null);var S=f?f.completion:{};return S.type=o,S.arg=u,f?(this.method="next",this.next=f.finallyLoc,D):this.complete(S)},complete:function(o,u){if(o.type==="throw")throw o.arg;return o.type==="break"||o.type==="continue"?this.next=o.arg:o.type==="return"?(this.rval=this.arg=o.arg,this.method="return",this.next="end"):o.type==="normal"&&u&&(this.next=u),D},finish:function(o){for(var u=this.tryEntries.length-1;u>=0;--u){var h=this.tryEntries[u];if(h.finallyLoc===o)return this.complete(h.completion,h.afterLoc),V(h),D}},catch:function(o){for(var u=this.tryEntries.length-1;u>=0;--u){var h=this.tryEntries[u];if(h.tryLoc===o){var p=h.completion;if(p.type==="throw"){var f=p.arg;V(h)}return f}}throw new Error("illegal catch attempt")},delegateYield:function(o,u,h){return this.delegate={iterator:q(o),resultName:u,nextLoc:h},this.method==="next"&&(this.arg=e),D}},t})(c.exports);try{regeneratorRuntime=r}catch{Function("r","regeneratorRuntime = r")(r)}}),d=we;function Z(c,r,t,i,n,e,s){try{var a=c[e](s),l=a.value}catch(v){t(v);return}a.done?r(l):Promise.resolve(l).then(i,n)}function ge(c){return function(){var r=this,t=arguments;return new Promise(function(i,n){var e=c.apply(r,t);function s(l){Z(e,i,n,s,a,"next",l)}function a(l){Z(e,i,n,s,a,"throw",l)}s(void 0)})}}var w=ge;function me(c,r){if(!(c instanceof r))throw new TypeError("Cannot call a class as a function")}var ne=me;function x(c,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(c,i.key,i)}}function ye(c,r,t){return r&&x(c.prototype,r),t&&x(c,t),c}var ae=ye;function Se(c,r,t){return r in c?Object.defineProperty(c,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):c[r]=t,c}var ke=Se;function be(c){for(var r=1;r<arguments.length;r++){var t=arguments[r]!=null?arguments[r]:{},i=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(t).filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),i.forEach(function(n){ke(c,n,t[n])})}return c}var Ie=be;function R(c){var r=c.method,t=c.path,i=c.body,n=i===void 0?null:i,e=c.headers,s=e===void 0?{}:e,a=c.credentials,l=a===void 0?"same-origin":a,v={method:r,headers:s,credentials:l};return n!==null&&(v.body=JSON.stringify(n),v.headers=Ie({"Content-Type":"application/json"},s)),fetch(t,v).then((function(){var k=w(d.mark(function y(g){return d.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(g.ok){b.next=3;break}return b.next=3,_e(g);case 3:return b.prev=3,b.next=6,g.json();case 6:return b.abrupt("return",b.sent);case 9:return b.prev=9,b.t0=b.catch(3),b.abrupt("return",null);case 12:case"end":return b.stop()}},y,null,[[3,9]])}));return function(y){return k.apply(this,arguments)}})())}function _e(c){return J.apply(this,arguments)}function J(){return J=w(d.mark(function c(r){var t,i,n,e,s,a;return d.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return v.prev=0,v.next=3,r.json();case 3:i=v.sent,n=i.error,e=n===void 0?"Unknown error":n,s=i.description,a=s===void 0?"No description":s,t="Unexpected status code ".concat(r.status,": ").concat(e,", ").concat(a),v.next=14;break;case 11:v.prev=11,v.t0=v.catch(0),t="Unexpected status code ".concat(r.status,": Cannot parse error response");case 14:throw new Error(t);case 15:case"end":return v.stop()}},c,null,[[0,11]])})),J.apply(this,arguments)}var Ee=(function(){function c(r){ne(this,c),this._instanceId=r,this._dbConn=null}return ae(c,[{key:"connect",value:function(){var t=this;return new Promise(function(i,n){var e=indexedDB.open(t._dbName);e.onsuccess=function(s){var a=s.target.result;t._dbConn=a,t._readState().then(function(l){return l===null?t.clear():Promise.resolve()}).then(i)},e.onupgradeneeded=function(s){var a=s.target.result;a.createObjectStore("beams",{keyPath:"instance_id"})},e.onerror=function(s){var a=new Error("Database error: ".concat(s.target.error));n(a)}})}},{key:"clear",value:function(){return this._writeState({instance_id:this._instanceId,device_id:null,token:null,user_id:null})}},{key:"_readState",value:function(){var t=this;if(!this.isConnected)throw new Error("Cannot read value: DeviceStateStore not connected to IndexedDB");return new Promise(function(i,n){var e=t._dbConn.transaction("beams").objectStore("beams").get(t._instanceId);e.onsuccess=function(s){var a=s.target.result;a||i(null),i(a)},e.onerror=function(s){n(s.target.error)}})}},{key:"_readProperty",value:(function(){var r=w(d.mark(function i(n){var e;return d.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this._readState();case 2:if(e=a.sent,e!==null){a.next=5;break}return a.abrupt("return",null);case 5:return a.abrupt("return",e[n]||null);case 6:case"end":return a.stop()}},i,this)}));function t(i){return r.apply(this,arguments)}return t})()},{key:"_writeState",value:function(t){var i=this;if(!this.isConnected)throw new Error("Cannot write value: DeviceStateStore not connected to IndexedDB");return new Promise(function(n,e){var s=i._dbConn.transaction("beams","readwrite").objectStore("beams").put(t);s.onsuccess=function(a){n()},s.onerror=function(a){e(a.target.error)}})}},{key:"_writeProperty",value:(function(){var r=w(d.mark(function i(n,e){var s;return d.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,this._readState();case 2:return s=l.sent,s[n]=e,l.next=6,this._writeState(s);case 6:case"end":return l.stop()}},i,this)}));function t(i,n){return r.apply(this,arguments)}return t})()},{key:"getToken",value:function(){return this._readProperty("token")}},{key:"setToken",value:function(t){return this._writeProperty("token",t)}},{key:"getDeviceId",value:function(){return this._readProperty("device_id")}},{key:"setDeviceId",value:function(t){return this._writeProperty("device_id",t)}},{key:"getUserId",value:function(){return this._readProperty("user_id")}},{key:"setUserId",value:function(t){return this._writeProperty("user_id",t)}},{key:"getLastSeenSdkVersion",value:function(){return this._readProperty("last_seen_sdk_version")}},{key:"setLastSeenSdkVersion",value:function(t){return this._writeProperty("last_seen_sdk_version",t)}},{key:"getLastSeenUserAgent",value:function(){return this._readProperty("last_seen_user_agent")}},{key:"setLastSeenUserAgent",value:function(t){return this._writeProperty("last_seen_user_agent",t)}},{key:"_dbName",get:function(){return"beams-".concat(this._instanceId)}},{key:"isConnected",get:function(){return this._dbConn!==null}}]),c})(),O="1.1.0",De=new RegExp("^(_|\\-|=|@|,|\\.|;|[A-Z]|[a-z]|[0-9])*$"),ee=164,re=5e3,te="/service-worker.js?pusherBeamsWebSDKVersion=".concat(O),W=Object.freeze({PERMISSION_PROMPT_REQUIRED:"PERMISSION_PROMPT_REQUIRED",PERMISSION_GRANTED_NOT_REGISTERED_WITH_BEAMS:"PERMISSION_GRANTED_NOT_REGISTERED_WITH_BEAMS",PERMISSION_GRANTED_REGISTERED_WITH_BEAMS:"PERMISSION_GRANTED_REGISTERED_WITH_BEAMS",PERMISSION_DENIED:"PERMISSION_DENIED"}),Ne=(function(){function c(r){if(ne(this,c),!r)throw new Error("Config object required");var t=r.instanceId,i=r.endpointOverride,n=i===void 0?null:i,e=r.serviceWorkerRegistration,s=e===void 0?null:e;if(t===void 0)throw new Error("Instance ID is required");if(typeof t!="string")throw new Error("Instance ID must be a string");if(t.length===0)throw new Error("Instance ID cannot be empty");if(!("indexedDB"in window))throw new Error("Pusher Beams does not support this browser version (IndexedDB not supported)");if(!window.isSecureContext)throw new Error("Pusher Beams relies on Service Workers, which only work in secure contexts. Check that your page is being served from localhost/over HTTPS");if(!("serviceWorker"in navigator))throw new Error("Pusher Beams does not support this browser version (Service Workers not supported)");if(!("PushManager"in window))throw new Error("Pusher Beams does not support this browser version (Web Push not supported)");if(s){var a=s.scope,l=window.location.href,v=l.startsWith(a);if(!v)throw new Error("Could not initialize Pusher web push: current page not in serviceWorkerRegistration scope (".concat(a,")"))}this.instanceId=t,this._deviceId=null,this._token=null,this._userId=null,this._serviceWorkerRegistration=s,this._deviceStateStore=new Ee(t),this._endpoint=n,this._ready=this._init()}return ae(c,[{key:"_init",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._deviceId===null){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._deviceStateStore.connect();case 4:if(!this._serviceWorkerRegistration){e.next=9;break}return e.next=7,window.navigator.serviceWorker.ready;case 7:e.next=12;break;case 9:return e.next=11,Pe();case 11:this._serviceWorkerRegistration=e.sent;case 12:return e.next=14,this._detectSubscriptionChange();case 14:return e.next=16,this._deviceStateStore.getDeviceId();case 16:return this._deviceId=e.sent,e.next=19,this._deviceStateStore.getToken();case 19:return this._token=e.sent,e.next=22,this._deviceStateStore.getUserId();case 22:this._userId=e.sent;case 23:case"end":return e.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_resolveSDKState",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ready;case 2:return e.next=4,this._detectSubscriptionChange();case 4:case"end":return e.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_detectSubscriptionChange",value:(function(){var r=w(d.mark(function i(){var n,e,s;return d.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,this._deviceStateStore.getToken();case 2:return n=l.sent,l.next=5,Re(this._serviceWorkerRegistration);case 5:if(e=l.sent,s=n!==e,!s){l.next=13;break}return l.next=10,this._deviceStateStore.clear();case 10:this._deviceId=null,this._token=null,this._userId=null;case 13:case"end":return l.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"getDeviceId",value:(function(){var r=w(d.mark(function i(){var n=this;return d.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,this._resolveSDKState();case 2:return s.abrupt("return",this._ready.then(function(){return n._deviceId}));case 3:case"end":return s.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"getToken",value:(function(){var r=w(d.mark(function i(){var n=this;return d.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,this._resolveSDKState();case 2:return s.abrupt("return",this._ready.then(function(){return n._token}));case 3:case"end":return s.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"getUserId",value:(function(){var r=w(d.mark(function i(){var n=this;return d.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,this._resolveSDKState();case 2:return s.abrupt("return",this._ready.then(function(){return n._userId}));case 3:case"end":return s.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_throwIfNotStarted",value:function(t){if(!this._deviceId)throw new Error("".concat(t,". SDK not registered with Beams. Did you call .start?"))}},{key:"start",value:(function(){var r=w(d.mark(function i(){var n,e,s,a;return d.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return v.next=2,this._resolveSDKState();case 2:if($()){v.next=4;break}return v.abrupt("return",this);case 4:if(this._deviceId===null){v.next=6;break}return v.abrupt("return",this);case 6:return v.next=8,this._getPublicKey();case 8:return n=v.sent,e=n.vapidPublicKey,v.next=12,this._getPushToken(e);case 12:return s=v.sent,v.next=15,this._registerDevice(s);case 15:return a=v.sent,v.next=18,this._deviceStateStore.setToken(s);case 18:return v.next=20,this._deviceStateStore.setDeviceId(a);case 20:return v.next=22,this._deviceStateStore.setLastSeenSdkVersion(O);case 22:return v.next=24,this._deviceStateStore.setLastSeenUserAgent(window.navigator.userAgent);case 24:return this._token=s,this._deviceId=a,v.abrupt("return",this);case 27:case"end":return v.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"getRegistrationState",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._resolveSDKState();case 2:if(Notification.permission!=="denied"){e.next=4;break}return e.abrupt("return",W.PERMISSION_DENIED);case 4:if(!(Notification.permission==="granted"&&this._deviceId!==null)){e.next=6;break}return e.abrupt("return",W.PERMISSION_GRANTED_REGISTERED_WITH_BEAMS);case 6:if(!(Notification.permission==="granted"&&this._deviceId===null)){e.next=8;break}return e.abrupt("return",W.PERMISSION_GRANTED_NOT_REGISTERED_WITH_BEAMS);case 8:return e.abrupt("return",W.PERMISSION_PROMPT_REQUIRED);case 9:case"end":return e.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"addDeviceInterest",value:(function(){var r=w(d.mark(function i(n){var e,s;return d.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,this._resolveSDKState();case 2:return this._throwIfNotStarted("Could not add Device Interest"),z(n),e="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this._deviceId,"/interests/").concat(encodeURIComponent(n)),s={method:"POST",path:e},l.next=8,R(s);case 8:case"end":return l.stop()}},i,this)}));function t(i){return r.apply(this,arguments)}return t})()},{key:"removeDeviceInterest",value:(function(){var r=w(d.mark(function i(n){var e,s;return d.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,this._resolveSDKState();case 2:return this._throwIfNotStarted("Could not remove Device Interest"),z(n),e="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this._deviceId,"/interests/").concat(encodeURIComponent(n)),s={method:"DELETE",path:e},l.next=8,R(s);case 8:case"end":return l.stop()}},i,this)}));function t(i){return r.apply(this,arguments)}return t})()},{key:"getDeviceInterests",value:(function(){var r=w(d.mark(function i(){var n,e;return d.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this._resolveSDKState();case 2:return this._throwIfNotStarted("Could not get Device Interests"),n="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this._deviceId,"/interests"),e={method:"GET",path:n},a.next=7,R(e);case 7:if(a.t0=a.sent.interests,a.t0){a.next=10;break}a.t0=[];case 10:return a.abrupt("return",a.t0);case 11:case"end":return a.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"setDeviceInterests",value:(function(){var r=w(d.mark(function i(n){var e,s,a,l,v,k,y,g,U;return d.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return m.next=2,this._resolveSDKState();case 2:if(this._throwIfNotStarted("Could not set Device Interests"),n!=null){m.next=5;break}throw new Error("interests argument is required");case 5:if(Array.isArray(n)){m.next=7;break}throw new Error("interests argument must be an array");case 7:if(!(n.length>re)){m.next=9;break}throw new Error("Number of interests (".concat(n.length,") exceeds maximum of ").concat(re));case 9:for(e=!0,s=!1,a=void 0,m.prev=12,l=n[Symbol.iterator]();!(e=(v=l.next()).done);e=!0)k=v.value,z(k);m.next=20;break;case 16:m.prev=16,m.t0=m.catch(12),s=!0,a=m.t0;case 20:m.prev=20,m.prev=21,!e&&l.return!=null&&l.return();case 23:if(m.prev=23,!s){m.next=26;break}throw a;case 26:return m.finish(23);case 27:return m.finish(20);case 28:return y=Array.from(new Set(n)),g="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this._deviceId,"/interests"),U={method:"PUT",path:g,body:{interests:y}},m.next=33,R(U);case 33:case"end":return m.stop()}},i,this,[[12,16,20,28],[21,,23,27]])}));function t(i){return r.apply(this,arguments)}return t})()},{key:"clearDeviceInterests",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._resolveSDKState();case 2:return this._throwIfNotStarted("Could not clear Device Interests"),e.next=5,this.setDeviceInterests([]);case 5:case"end":return e.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"setUserId",value:(function(){var r=w(d.mark(function i(n,e){var s,a,l,v,k;return d.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.next=2,this._resolveSDKState();case 2:if($()){g.next=4;break}return g.abrupt("return");case 4:if(this._deviceId!==null){g.next=7;break}return s=new Error(".start must be called before .setUserId"),g.abrupt("return",Promise.reject(s));case 7:if(typeof n=="string"){g.next=9;break}throw new Error("User ID must be a string (was ".concat(n,")"));case 9:if(n!==""){g.next=11;break}throw new Error("User ID cannot be the empty string");case 11:if(!(this._userId!==null&&this._userId!==n)){g.next=13;break}throw new Error("Changing the `userId` is not allowed.");case 13:return a="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this._deviceId,"/user"),g.next=16,e.fetchToken(n);case 16:return l=g.sent,v=l.token,k={method:"PUT",path:a,headers:{Authorization:"Bearer ".concat(v)}},g.next=21,R(k);case 21:return this._userId=n,g.abrupt("return",this._deviceStateStore.setUserId(n));case 23:case"end":return g.stop()}},i,this)}));function t(i,n){return r.apply(this,arguments)}return t})()},{key:"stop",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._resolveSDKState();case 2:if($()){e.next=4;break}return e.abrupt("return");case 4:if(this._deviceId!==null){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,this._deleteDevice();case 8:return e.next=10,this._deviceStateStore.clear();case 10:this._clearPushToken().catch(function(){}),this._deviceId=null,this._token=null,this._userId=null;case 14:case"end":return e.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"clearAllState",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if($()){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.stop();case 4:return e.next=6,this.start();case 6:case"end":return e.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_getPublicKey",value:(function(){var r=w(d.mark(function i(){var n,e;return d.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return n="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/web-vapid-public-key"),e={method:"GET",path:n},a.abrupt("return",R(e));case 3:case"end":return a.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_getPushToken",value:(function(){var r=w(d.mark(function i(n){var e;return d.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,this._clearPushToken();case 3:return a.next=5,this._serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Ce(n)});case 5:return e=a.sent,a.abrupt("return",btoa(JSON.stringify(e)));case 9:return a.prev=9,a.t0=a.catch(0),a.abrupt("return",Promise.reject(a.t0));case 12:case"end":return a.stop()}},i,this,[[0,9]])}));function t(i){return r.apply(this,arguments)}return t})()},{key:"_clearPushToken",value:(function(){var r=w(d.mark(function i(){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",navigator.serviceWorker.ready.then(function(s){return s.pushManager.getSubscription()}).then(function(s){s&&s.unsubscribe()}));case 1:case"end":return e.stop()}},i)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_registerDevice",value:(function(){var r=w(d.mark(function i(n){var e,s,a,l;return d.wrap(function(k){for(;;)switch(k.prev=k.next){case 0:return e="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web"),s={token:n,metadata:{sdkVersion:O}},a={method:"POST",path:e,body:s},k.next=5,R(a);case 5:return l=k.sent,k.abrupt("return",l.id);case 7:case"end":return k.stop()}},i,this)}));function t(i){return r.apply(this,arguments)}return t})()},{key:"_deleteDevice",value:(function(){var r=w(d.mark(function i(){var n,e;return d.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return n="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(encodeURIComponent(this._deviceId)),e={method:"DELETE",path:n},a.next=4,R(e);case 4:case"end":return a.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_updateDeviceMetadata",value:(function(){var r=w(d.mark(function i(){var n,e,s,a,l,v;return d.wrap(function(y){for(;;)switch(y.prev=y.next){case 0:return n=window.navigator.userAgent,y.next=3,this._deviceStateStore.getLastSeenUserAgent();case 3:return e=y.sent,y.next=6,this._deviceStateStore.getLastSeenSdkVersion();case 6:if(s=y.sent,!(n===e&&O===s)){y.next=9;break}return y.abrupt("return");case 9:return a="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this._deviceId,"/metadata"),l={sdkVersion:O},v={method:"PUT",path:a,body:l},y.next=14,R(v);case 14:return y.next=16,this._deviceStateStore.setLastSeenSdkVersion(O);case 16:return y.next=18,this._deviceStateStore.setLastSeenUserAgent(n);case 18:case"end":return y.stop()}},i,this)}));function t(){return r.apply(this,arguments)}return t})()},{key:"_baseURL",get:function(){return this._endpoint!==null?this._endpoint:"https://".concat(this.instanceId,".pushnotifications.pusher.com")}}]),c})(),z=function(r){if(r==null)throw new Error("Interest name is required");if(typeof r!="string")throw new Error("Interest ".concat(r," is not a string"));if(!De.test(r))throw new Error('interest "'.concat(r,'" contains a forbidden character. ')+"Allowed characters are: ASCII upper/lower-case letters, numbers or one of _-=@,.;");if(r.length>ee)throw new Error("Interest is longer than the maximum of ".concat(ee," chars"))};function Pe(){return Q.apply(this,arguments)}function Q(){return Q=w(d.mark(function c(){var r,t;return d.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,fetch(te);case 2:if(r=n.sent,t=r.status,t===200){n.next=6;break}throw new Error("Cannot start SDK, service worker missing: No file found at /service-worker.js");case 6:return window.navigator.serviceWorker.register(te,{updateViaCache:"none"}),n.abrupt("return",window.navigator.serviceWorker.ready);case 8:case"end":return n.stop()}},c)})),Q.apply(this,arguments)}function Re(c){return c.pushManager.getSubscription().then(function(r){return r?Te(r):null})}function Te(c){return btoa(JSON.stringify(c))}function Ce(c){var r="=".repeat((4-c.length%4)%4),t=(c+r).replace(/-/g,"+").replace(/_/g,"/"),i=window.atob(t);return Uint8Array.from(fe(i).map(function(n){return n.charCodeAt(0)}))}function $(){var c=window.navigator,r=c.vendor,t=window.chrome!==null&&typeof window.chrome<"u",i=c.userAgent.indexOf("OPR")>-1,n=c.userAgent.indexOf("Edg")>-1,e=c.userAgent.indexOf("Firefox")>-1,s=t&&r==="Google Inc."&&!n&&!i,a=s||i||e||n;return a||console.warn("Pusher Web Push Notifications supports Chrome, Firefox, Edge and Opera."),a}export{Ne as C};
